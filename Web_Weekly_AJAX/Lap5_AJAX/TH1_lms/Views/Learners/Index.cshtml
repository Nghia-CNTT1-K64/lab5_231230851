@model IEnumerable<TH1_lms.Models.Learner>
@{
    ViewData["Title"] = "Index";
    Layout = "MyLayout";
}

<h1>Danh sách Learners</h1>

<!-- Gọi ViewComponent Major -->
@await Component.InvokeAsync("Major")

<p>
    <a asp-action="Create" class="btn btn-primary">Create New</a>
</p>

<!-- FORM TÌM KIẾM -->
<div class="row mb-3">
    <div class="col-md-6">
        <input type="text"
               id="searchInput"
               class="form-control"
               placeholder="Tìm kiếm theo tên..."
               value="@ViewBag.searchString" />
    </div>
    <div class="col-md-3">
        <button id="btnSearch" class="btn btn-success">Tìm kiếm</button>
        <button id="btnReset" class="btn btn-secondary">Reset</button>
    </div>
</div>

<div id="content">
    <!-- Partial View sẽ được load vào đây -->
    @await Html.PartialAsync("LearnerTable", Model)
</div>

@section Scripts {
    <script>
        // Biến toàn cục lưu trạng thái filter
        var currentMid = @(ViewBag.mid ?? "null");
        var currentKeyword = "@(ViewBag.searchString ?? "")";

        // Click vào major để lọc
        $(".major-item").click(function () {
            var id = $(this).attr("data-id");
            currentMid = id;
            loadLearners(id, currentKeyword, 1);
        });

        // Click nút tìm kiếm
        $("#btnSearch").click(function () {
            currentKeyword = $("#searchInput").val();
            loadLearners(currentMid, currentKeyword, 1);
        });

        // Enter trong ô tìm kiếm
        $("#searchInput").keypress(function (e) {
            if (e.which == 13) { // Enter key
                currentKeyword = $(this).val();
                loadLearners(currentMid, currentKeyword, 1);
            }
        });

        // Click nút Reset
        $("#btnReset").click(function () {
            currentMid = null;
            currentKeyword = "";
            $("#searchInput").val("");
            loadLearners(null, "", 1);
        });

        // Hàm chung để load learners
        function loadLearners(mid, keyword, page) {
            $.ajax({
                url: "/Learners/LearnerFilter",
                data: {
                    mid: mid,
                    keyword: keyword,
                    pageIndex: page
                },
                success: function (response) {
                    $("#content").html(response);
                },
                error: function () {
                    alert("Có lỗi xảy ra!");
                }
            });
        }

        // Xử lý click phân trang (delegate event vì phân trang được load động)
        $(document).on("click", ".page-link", function (e) {
            e.preventDefault();
            var page = $(this).data("page");
            loadLearners(currentMid, currentKeyword, page);
        });
    </script>
}